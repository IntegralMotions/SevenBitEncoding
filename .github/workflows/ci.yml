name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} / ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
      actions: write 
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Release]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy

      - name: Configure
        run: make BUILD_TYPE=${{ matrix.build_type }} configure

      - name: Code analysis (clang-format + clang-tidy)
        run: |
          files_all=$(git ls-files '*.c' '*.cpp' '*.h' '*.hpp')
          files_cpp=$(git ls-files '*.c' '*.cpp')

          : > analysis.log
          status=0

          echo "=== clang-format ===" >> analysis.log
          for f in $files_all; do
            clang-format --dry-run --Werror "$f" >> analysis.log 2>&1 || status=1
          done

          echo "" >> analysis.log
          echo "=== clang-tidy ===" >> analysis.log
          for f in $files_cpp; do
            clang-tidy "$f" -p build >> analysis.log 2>&1 || status=1
          done

          # Emit GitHub annotations
          while IFS= read -r line; do
            if echo "$line" | grep -qE ":[0-9]+:[0-9]+: warning:"; then
              file=$(echo "$line" | cut -d: -f1)
              row=$(echo "$line" | cut -d: -f2)
              col=$(echo "$line" | cut -d: -f3)
              msg=$(echo "$line" | cut -d: -f5-)
              echo "::warning file=$file,line=$row,col=$col::$msg"
            elif echo "$line" | grep -qE ":[0-9]+:[0-9]+: error:"; then
              file=$(echo "$line" | cut -d: -f1)
              row=$(echo "$line" | cut -d: -f2)
              col=$(echo "$line" | cut -d: -f3)
              msg=$(echo "$line" | cut -d: -f5-)
              echo "::error file=$file,line=$row,col=$col::$msg"
            fi
          done < analysis.log

          exit $status

      - name: Publish code analysis report
        if: always()
        uses: dorny/analysis-action@v2
        with:
          name: Code Quality (clang)
          artifact: code-analysis
          path: analysis.log
          reporter: gcc         
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload raw log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis
          path: analysis.log

      - name: Build
        run: make BUILD_TYPE=${{ matrix.build_type }} build

      - name: Test
        id: test
        env:
          GTEST_COLOR: 1
        run: |
          ctest --test-dir build \
                --output-on-failure \
                -C ${{ matrix.build_type }} \
                --output-junit test-results.xml

      - name: Publish test report
        if: ${{ always() && steps.test.outcome != 'skipped' }}
        uses: dorny/test-reporter@v1
        with:
          name: GoogleTest (${{ matrix.os }} / ${{ matrix.build_type }})
          path: build/test-results.xml
          reporter: java-junit
          fail-on-error: false
